<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Superbrain Vision AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-blue-50 min-h-screen">
    <div id="root"></div>
    
    <script>
        let apiKey = '';
        let messages = [];
        let isLoading = false;
        let selectedImage = null;
        let imagePreview = null;

        function render() {
            const root = document.getElementById('root');
            
            if (!apiKey) {
                root.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                            <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent mb-2 text-center">
                                Superbrain Vision
                            </h1>
                            <p class="text-gray-600 text-center mb-6">AI Image Analysis</p>
                            
                            <input 
                                type="password" 
                                id="apiKeyInput" 
                                placeholder="Enter your Groq API Key" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none mb-4"
                            >
                            
                            <button 
                                onclick="setApiKey()" 
                                class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 rounded-lg font-semibold hover:from-purple-700 hover:to-blue-700 transition"
                            >
                                Start
                            </button>
                            
                            <p class="text-xs text-gray-500 text-center mt-4">
                                Get free API key: <a href="https://console.groq.com/keys" target="_blank" class="text-purple-600 underline">console.groq.com/keys</a>
                            </p>
                        </div>
                    </div>
                `;
                
                setTimeout(() => {
                    const input = document.getElementById('apiKeyInput');
                    if (input) {
                        input.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') setApiKey();
                        });
                    }
                }, 0);
                
                return;
            }

            let messagesHtml = '';
            
            if (messages.length === 0) {
                messagesHtml = `
                    <div class="text-center text-gray-500 mt-12">
                        <div class="text-6xl mb-4">üß†</div>
                        <p class="text-xl font-semibold mb-2">Superbrain Ready</p>
                        <p class="text-sm">Upload an image and ask questions about it</p>
                        <p class="text-xs mt-4 text-gray-400">Model: llama-3.2-11b-vision-preview</p>
                    </div>
                `;
            } else {
                messages.forEach(msg => {
                    const isUser = msg.role === 'user';
                    messagesHtml += `
                        <div class="flex ${isUser ? 'justify-end' : 'justify-start'} mb-4">
                            <div class="max-w-[80%] rounded-2xl px-4 py-3 ${
                                isUser 
                                    ? 'bg-gradient-to-r from-purple-600 to-blue-600 text-white' 
                                    : 'bg-gray-100 text-gray-800'
                            }">
                                ${msg.image ? `<img src="${msg.image}" class="max-w-full rounded-lg mb-2 max-h-64 object-contain border-2 border-white">` : ''}
                                <p class="whitespace-pre-wrap break-words">${msg.text}</p>
                            </div>
                        </div>
                    `;
                });
            }

            if (isLoading) {
                messagesHtml += `
                    <div class="flex justify-start mb-4">
                        <div class="bg-gray-100 rounded-2xl px-6 py-4">
                            <div class="flex items-center gap-2">
                                <div class="animate-spin h-5 w-5 border-3 border-purple-600 border-t-transparent rounded-full"></div>
                                <span class="text-gray-600 text-sm">Analyzing...</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            root.innerHTML = `
                <div class="max-w-4xl mx-auto p-4 h-screen flex flex-col">
                    <div class="bg-white rounded-t-2xl shadow-lg p-4 border-b">
                        <div class="flex justify-between items-center">
                            <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                                Superbrain Vision
                            </h1>
                            <button 
                                onclick="resetApp()" 
                                class="text-sm text-gray-600 hover:text-gray-800 px-3 py-1 rounded hover:bg-gray-100 transition"
                            >
                                Reset API Key
                            </button>
                        </div>
                    </div>

                    <div class="flex-1 bg-white shadow-lg overflow-y-auto p-6" id="messagesContainer">
                        ${messagesHtml}
                    </div>

                    <div class="bg-white rounded-b-2xl shadow-lg p-4">
                        <div id="imagePreviewContainer"></div>
                        
                        <div class="flex gap-2">
                            <input type="file" id="imageInput" accept="image/*" class="hidden">
                            
                            <button 
                                onclick="document.getElementById('imageInput').click()" 
                                class="bg-gray-100 p-3 rounded-lg hover:bg-gray-200 transition flex-shrink-0"
                                title="Upload image"
                            >
                                <span class="text-2xl">üì∑</span>
                            </button>
                            
                            <input 
                                type="text" 
                                id="messageInput" 
                                placeholder="Type your question or upload an image..." 
                                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                                ${isLoading ? 'disabled' : ''}
                            >
                            
                            <button 
                                onclick="sendMessage()" 
                                class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-lg hover:from-purple-700 hover:to-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0"
                                ${isLoading ? 'disabled' : ''}
                            >
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            `;

            setTimeout(() => {
                const container = document.getElementById('messagesContainer');
                if (container) container.scrollTop = container.scrollHeight;
                
                const input = document.getElementById('messageInput');
                if (input) {
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !isLoading) sendMessage();
                    });
                }
                
                const fileInput = document.getElementById('imageInput');
                if (fileInput) {
                    fileInput.addEventListener('change', handleImageSelect);
                }
            }, 0);
        }

        function setApiKey() {
            const input = document.getElementById('apiKeyInput');
            const key = input?.value?.trim();
            
            if (!key) {
                alert('Please enter your Groq API key');
                return;
            }
            
            apiKey = key;
            render();
        }

        function resetApp() {
            if (confirm('Reset API key and clear all messages?')) {
                apiKey = '';
                messages = [];
                selectedImage = null;
                imagePreview = null;
                render();
            }
        }

        function handleImageSelect(e) {
            const file = e.target.files[0];
            
            if (!file) return;
            
            if (file.size > 20 * 1024 * 1024) {
                alert('Image is too large. Maximum size is 20MB.');
                e.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(event) {
                imagePreview = event.target.result;
                selectedImage = event.target.result;
                
                const preview = document.getElementById('imagePreviewContainer');
                if (preview) {
                    preview.innerHTML = `
                        <div class="mb-3 relative inline-block">
                            <img src="${imagePreview}" class="max-h-32 rounded-lg border-2 border-purple-300 shadow">
                            <button 
                                onclick="clearImage()" 
                                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-7 h-7 hover:bg-red-600 transition font-bold shadow-lg"
                            >
                                √ó
                            </button>
                        </div>
                    `;
                }
            };
            
            reader.onerror = function() {
                alert('Error reading image file. Please try again.');
                e.target.value = '';
            };
            
            reader.readAsDataURL(file);
        }

        function clearImage() {
            selectedImage = null;
            imagePreview = null;
            
            const fileInput = document.getElementById('imageInput');
            if (fileInput) fileInput.value = '';
            
            const preview = document.getElementById('imagePreviewContainer');
            if (preview) preview.innerHTML = '';
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input?.value?.trim() || '';
            
            if (!text && !selectedImage) {
                alert('Please type a message or upload an image');
                return;
            }
            
            if (isLoading) return;

            const userMessage = text || "Analyze this image in detail";
            
            messages.push({
                role: 'user',
                text: userMessage,
                image: imagePreview
            });

            if (input) input.value = '';
            isLoading = true;
            render();

            try {
                const content = [
                    { type: "text", text: userMessage }
                ];
                
                if (selectedImage) {
                    content.push({
                        type: "image_url",
                        image_url: { 
                            url: selectedImage
                        }
                    });
                }

                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama-3.2-11b-vision-preview',
                        messages: [{
                            role: 'user',
                            content: content
                        }],
                        temperature: 0.7,
                        max_tokens: 2048
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    const errorMsg = data.error?.message || data.error || 'API request failed';
                    throw new Error(errorMsg);
                }

                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('Invalid response from API');
                }

                const assistantText = data.choices[0].message.content;
                
                messages.push({
                    role: 'assistant',
                    text: assistantText
                });

                clearImage();
                
            } catch (error) {
                console.error('Error:', error);
                
                let errorMessage = `‚ùå Error: ${error.message}`;
                
                if (error.message.includes('401') || error.message.includes('authentication')) {
                    errorMessage += '\n\n‚úì Check your API key at console.groq.com/keys';
                } else if (error.message.includes('429') || error.message.includes('rate limit')) {
                    errorMessage += '\n\n‚úì Rate limit reached. Wait a moment and try again.';
                } else if (error.message.includes('model')) {
                    errorMessage += '\n\n‚úì Vision model may be unavailable. Try again later.';
                } else {
                    errorMessage += '\n\n‚úì Make sure you have internet connection\n‚úì Verify your Groq API key is valid\n‚úì Check if image is under 20MB';
                }
                
                messages.push({
                    role: 'assistant',
                    text: errorMessage
                });
                
            } finally {
                isLoading = false;
                render();
            }
        }

        render();
    </script>
</body>
</html>
